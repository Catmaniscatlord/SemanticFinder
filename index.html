
<!DOCTYPE html>
<html>
<head>
    <title>SemanticFinder - Frontend-only Semantic Search with transformers.js</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/codemirror.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/codemirror.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/mode/javascript/javascript.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.56.0/addon/search/searchcursor.min.js"></script>

<!--    <script data-goatcounter="https://georocks.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>-->
    <style>

        #input-text {
            height:50vh;
            width:80vw;
            min-width: 80vw;
            text-align: left !important;
        }



        .CodeMirror{
            height: 55vh;
        }

        table {
            table-layout: auto;
            margin: 0 auto;
        }
        th,
        td {
            word-wrap: break-word;
            max-width: 50%;
            text-align: center;
        }

        .table-bordered {
            border: none;
        }

        #output-table > tbody > tr:nth-of-type(odd) {
            background-color: #f9f9f9;
        }

        .table .table {
            background-color: transparent;
        }

        .highlight-first {
            background-color: rgb(0, 255, 81);
        }

        .highlight-second {
            background-color: rgb(135, 255, 153);
        }

        .highlight-third {
            background-color: rgb(190, 253, 190);
        }

        .highlight-select {
            background-color: orange;
        }


        #loading {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            -webkit-animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                -webkit-transform: rotate(360deg);
            }
        }
        @-webkit-keyframes spin {
            to {
                -webkit-transform: rotate(360deg);
            }
        }

        #progressBar{
            height: 25px;
            width: 100%;
            margin-left: 5px;
        }

        #progressBarProgress{
            margin-left: 5px;
        }

        #query-text{
            min-width: 80%;
        }

        #formGroupCenter{
            width: 100%;
        }

        .CodeMirror {
            font-size: 15px;
        }

        #results {
            height: 100vh;
            overflow-y: auto;
        }

        .card {
            width: 100%;
            transition: background-color 0.3s ease;
        }

        .card:hover {
            background-color: #f8f9fa;
        }

        .submit-button {
            width: 100px; /* adjust this to the size you want */
            margin-right: 1px; /* adds space between buttons */
        }

        .nav-button {
            width: 60px; /* adjust this to the size you want */
            margin-right: 1px; /* adds space between buttons */
        }

        #submitGroup {
            margin-top: 2vh; /* adjust this value as needed */
        }
        .card-title {
            font-size: 0.9em;
        }
        .card-subtitle {
            font-size: 0.8em;
        }



    </style>
</head>
<body>
<br />
<h1 class="text-center"><span class="highlight-first" >SemanticFinder</span></h1>
<h2 class="text-center">Frontend-only live semantic search with <a href="https://xenova.github.io/transformers.js/" target="_blank">transformers.js</a>. <a href="https://github.com/do-me/SemanticFinder">GitHub</a></h2>
<div class="text-center" style="margin: 0 auto; max-width: 65%;">
    <p>Semantic Search right in your browser! This tool calculates embeddings and cosine similarity client-side, without the need for server-side inferencing. Built on a <a href="https://github.com/xenova/transformers.js/issues/36#issuecomment-1476842324">quantized version</a> of the <a href="https://huggingface.co/sentence-transformers/all-MiniLM-L6-v2">sentence-transformers/all-MiniLM-L6-v2</a>.

        This is a demo for a <a href="https://geo.rocks/post/semanticfinder-semantic-search-frontend-only/">related blog post</a>. It builds on two previous posts about vector search, which you can find here: <a href="https://geo.rocks/post/qdrant-transformers-js-semantic-search//">[1]</a>, <a href="https://geo.rocks/post/geospatial-vector-search-qdrant/">[2]</a>.

        All code self-contained in a single HTML file. You can <a href="#" onclick="downloadPage()">download this page</a>.

        For further exploration, check out these pre-indexed examples: <a href="https://geo.rocks/semanticfinder/ipcc" >IPCC Report 2023 (85 pages)</a> and the <a href="https://geo.rocks/semanticfinder/ipcc-summary" >IPCC Summary 2023 (35 pages)</a>.

        To use Semantic Search, simply copy and paste any text and hit Submit. For a more refined search, enter a lower character count. For a broader search, enter a higher one.</p>

</div>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-sm-9"> <!-- 80% column for text region-->
            <form class="form-floating" onsubmit="onSubmit(); return false;">
                <div class="form-group" id="formGroupCenter">
                    <!-- advanced features-->

                    <div class="form-floating mb-3">
                        <input type="text" id="query-text" class="form-control" placeholder="Enter query here" value="food" />
                        <label for="query-text">query</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="number" id="token-length" class="form-control w-100" placeholder="Enter no. of chars" value="50" />
                                <label for="token-length"># chars</label>
                            </div>
                        </div>
<!--                        put button here "Advanced"-->
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="number" id="threshold" class="form-control w-100" placeholder="Similarity threshold" value="0.3" step="0.01" />
                                <label for="threshold">threshold</label>
                            </div>
                        </div>

                    </div>
                    <!-- text-->
                    <div class="form-floating">
                        <textarea id="input-text" class="form-control" placeholder="Enter notes here">Near a great forest there lived a poor woodcutter and his wife, and his two children; the boy's name was Hansel and the girl's Grethel. They had very little to bite or to sup, and once, when there was great dearth in the land, the man could not even gain the daily bread. As he lay in bed one night thinking of this, and turning and tossing, he sighed heavily, and said to his wife, "What will become of us? we cannot even feed our children; there is nothing left for ourselves."
"I will tell you what, husband," answered the wife; "we will take the children early in the morning into the forest, where it is thickest; we will make them a fire, and we will give each of them a piece of bread, then we will go to our work and leave them alone; they will never find the way home again, and we shall be quit of them."
"No, wife," said the man, "I cannot do that; I cannot find in my heart to take my children into the forest and to leave them there alone; the wild animals would soon come and devour them." - "O you fool," said she, "then we will all four starve; you had better get the coffins ready," and she left him no peace until he consented. "But I really pity the poor children," said the man.
The two children had not been able to sleep for hunger, and had heard what their step-mother had said to their father. Grethel wept bitterly, and said to Hansel, "It is all over with us."
"Do be quiet, Grethel," said Hansel, "and do not fret; 1 will manage something." And when the parents had gone to sleep he got up, put on his little coat, opened the back door, and slipped out. The moon was shining brightly, and the white flints that lay in front of the house glistened like pieces of silver. Hansel stooped and filled the little pocket of his coat as full as it would hold. Then he went back again, and said to Grethel, "Be easy, dear little sister, and go to sleep quietly; God will not forsake us," and laid himself down again in his bed. When the day was breaking, and before the sun had risen, the wife came and awakened the two children, saying, "Get up, you lazy bones; we are going into the forest to cut wood." Then she gave each of them a piece of bread, and said, "That is for dinner, and you must not eat it before then, for you will get no more." Grethel carried the bread under her apron, for Hansel had his pockets full of the flints. Then they set off all together on their way to the forest. When they had gone a little way Hansel stood still and looked back towards the house, and this he did again and again, till his father said to him, "Hansel, what are you looking at? take care not to forget your legs."
"O father," said Hansel, "lam looking at my little white kitten, who is sitting up on the roof to bid me good-bye." - "You young fool," said the woman, "that is not your kitten, but the sunshine on the chimney-pot." Of course Hansel had not been looking at his kitten, but had been taking every now and then a flint from his pocket and dropping it on the road. When they reached the middle of the forest the father told the children to collect wood to make a fire to keep them, warm; and Hansel and Grethel gathered brushwood enough for a little mountain j and it was set on fire, and when the flame was burning quite high the wife said, "Now lie down by the fire and rest yourselves, you children, and we will go and cut wood; and when we are ready we will come and fetch you."
So Hansel and Grethel sat by the fire, and at noon they each ate their pieces of bread. They thought their father was in the wood all the time, as they seemed to hear the strokes of the axe: but really it was only a dry branch hanging to a withered tree that the wind moved to and fro. So when they had stayed there a long time their eyelids closed with weariness, and they fell fast asleep.
When at last they woke it was night, and Grethel began to cry, and said, "How shall we ever get out of this wood? "But Hansel comforted her, saying, "Wait a little while longer, until the moon rises, and then we can easily find the way home." And when the full moon got up Hansel took his little sister by the hand, and followed the way where the flint stones shone like silver, and showed them the road. They walked on the whole night through, and at the break of day they came to their father's house. They knocked at the door, and when the wife opened it and saw that it was Hansel and Grethel she said, "You naughty children, why did you sleep so long in the wood? we thought you were never coming home again!" But the father was glad, for it had gone to his heart to leave them both in the woods alone.
Not very long after that there was again great scarcity in those parts, and the children heard their mother say at night in bed to their father, "Everything is finished up; we have only half a loaf, and after that the tale comes to an end. The children must be off; we will take them farther into the wood this time, so that they shall not be able to find the way back again; there is no other way to manage." The man felt sad at heart, and he thought, "It would better to share one's last morsel with one's children." But the wife would listen to nothing that he said, but scolded and reproached him. He who says A must say B too, and when a man has given in once he has to do it a second time.
 </textarea>
                    </div>
                </div>

                <!-- submit group-->
                <div class="text-center" id="submitGroup">
                    <button type="submit" id="submit_button" class="btn btn-primary mb-2 submit-button" disabled>
                        <div id="loading"></div>
                        Loading model...
                    </button>
                    <button id="prev" class="btn btn-secondary mb-2 nav-button" disabled>
                        prev
                    </button>
                    <button id="next" class="btn btn-secondary mb-2 nav-button" disabled>
                        next
                    </button>
                </div>

            </form>
            <div>
                <label id="progressBarLabel" for="progressBar">Progress:</label>
                <div style="display: flex; align-items: center;">
                    <p id="progressBarProgress" style="margin: 0 2px 0 0; position: relative; top: 2px;">0%</p>
                    <progress id="progressBar" value="0" max="100" role="progressbar"></progress>
                </div>
            </div>


        </div>

        <div class="col-sm-3"> <!-- 20% column -->
            <div id="results">
                <ul id="results-list"> </ul>
            </div>
        </div>


    </div>
</div>



<script type="module">
    import { pipeline, AutoTokenizer } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.2.0/dist/transformers.min.js';

    let embeddingsDict = {};
    let markers = [];
    let progressBar = $("#progressBar");
    let progressBarProgress = $("#progressBarProgress");

    function removeHighlights() {
        for (let marker of markers) {
            marker.clear();
        }
        markers = [];
    }

    const submitButton = document.getElementById("submit_button");

    function activateSubmitButton() {
        // get references to the loading element and submit button
        const loadingElement = document.getElementById("loading");

        // remove the loading element and enable the submit button
        if (loadingElement) {
            loadingElement.remove();
        }

        if (submitButton) {
            submitButton.removeAttribute("disabled");
            submitButton.textContent = "Submit";
        }
    }

    let isProcessing = false;

    async function onSubmit() {
        if (!isProcessing) {
            isProcessing = true;
            submitButton.textContent = "Stop";

            document.getElementById('results-list').innerHTML = '';
            selectedIndex = -1;
            await semanticHighlight(finishCallback);
        } else {
            submitButton.textContent = "Submit"
            isProcessing = false;
        }
    }
    window.onSubmit = onSubmit;


    function createHighlight(text, className, similarity) {
        let resultsDiv = document.getElementById('results-list');
        const cursor = editor.getSearchCursor(text);

        while (cursor.findNext()) {
            let marker = editor.markText(cursor.from(), cursor.to(), {className: className});
            markers.push(marker);

            // create card
            let listItem = document.createElement('div');
            listItem.classList.add('card');
            listItem.innerHTML = createCardHTML(text, similarity);

            resultsDiv.appendChild(listItem);

            let index = resultsDiv.childElementCount - 1;

            // Add click listener for card
            listItem.addEventListener('click', function() {
                editor.scrollIntoView(markers[index].find());
                highlightSelected(index);
            });
        }
    }

    function updateResults(results) {
        // Remove previous highlights
        removeHighlights();

        // Get results list element
        let resultsDiv = document.getElementById('results-list');
        resultsDiv.innerHTML = '';

        for (let i = 0; i < results.length; i++) {
            let resultItem = results[i];
            if (resultItem[1] < $("#threshold").val()) { break; } // redundant

            let highlightClass;
            if (i === 0) highlightClass = "highlight-first";
            else if (i === 1) highlightClass = "highlight-second";
            else highlightClass = "highlight-third";

            createHighlight(resultItem[0], highlightClass, resultItem[1]);

        }
    }

    function createCardHTML(title, similarity) {
        return `
        <div class="card-body">
            <h5 class="card-title">${title}</h5>
            <h6 class="card-subtitle mb-2 text-muted">similarity: ${similarity.toFixed(2)}</h6>
        </div>
    `;
    }


    let selectedIndex = -1;
    let selectedClassName;

    function highlightSelected(index) {
        highlightCard(index);
        if (selectedIndex !== -1) {
            let marker0 = editor.markText(markers[selectedIndex].find().from, markers[selectedIndex].find().to, {className: selectedClassName});
            markers[selectedIndex].clear();
            markers[selectedIndex] = marker0;
        }

        selectedIndex = index;
        selectedClassName = markers[selectedIndex].className;

        let marker1 = editor.markText(markers[selectedIndex].find().from, markers[selectedIndex].find().to, {className: "highlight-select"});
        markers[selectedIndex].clear();
        markers[selectedIndex] = marker1;
    }

    let prevCard;
    function highlightCard(index) {
        let resultsDiv = document.getElementById('results-list');
        let cards = resultsDiv.getElementsByClassName('card');

        if (prevCard) {
            prevCard.style.backgroundColor = '';
        }
        prevCard = cards[index];
        cards[index].style.backgroundColor = '#f4ac90';
    }

    function resetHighlightsProgress(){
        // clear any highlights
        removeHighlights();
        progressBar.attr("value", 0);
        progressBarProgress.text(`${0}`);

    }

    async function embed(text) {
        if (text in embeddingsDict) {
            return embeddingsDict[text];
        }

        let e0 = await embedder(text, { pooling: 'mean', normalize: true });
        embeddingsDict[text] = e0["data"];
        return e0["data"];
    }

    function calculateCosineSimilarity(queryEmbedding, embedding) {
        let dotProduct = 0;
        let queryMagnitude = 0;
        let embeddingMagnitude = 0;
        let queryEmbeddingLength = queryEmbedding.length
        for (let i = 0; i < queryEmbeddingLength; i++) {
            dotProduct += queryEmbedding[i] * embedding[i];
            queryMagnitude += queryEmbedding[i] ** 2;
            embeddingMagnitude += embedding[i] ** 2;
        }
        return dotProduct / (Math.sqrt(queryMagnitude) * Math.sqrt(embeddingMagnitude));
    }

    async function similarity(text) {
        let inputQuery = $("#query-text").val();
        let inputEmbedding = await embed(inputQuery);

        if (Array.isArray(text)) {
            // if text is array embed each item individually
            let similarities = [];
            for (let i = 0; i < text.length; i++) {
                let textEmbedding = await embed(text[i]);
                similarities.push(calculateCosineSimilarity(inputEmbedding, textEmbedding));
            }
            return similarities;
        }
        let textEmbedding = await embed(text);
        return calculateCosineSimilarity(inputEmbedding, textEmbedding);
    }



    async function semanticHighlight(callback) {
        deactivateScrollButtons();
        resetHighlightsProgress();

        // query input embedding
        const text = editor.getValue("");
        let inputTexts = splitSubstrings(text,$("#token-length").val());

        let results = [];
        let max = inputTexts.length;

        let i = 0;

        // all are set into play async then function continues
        let interval = setInterval(async () => {
            let inputText = inputTexts[i];
            if (i >= max || !isProcessing) {
                clearInterval(interval);
                callback();
                return;
            }
            i++;


            let cosineSimilarity = await similarity(inputText);

            results.push([inputText, cosineSimilarity]);
            results.sort((a, b) => b[1] - a[1]);

            updateResults(results);
            if (markers.length > 0 && (selectedIndex === -1 || selectedIndex === 0)) {
                editor.scrollIntoView(markers[0].find());
            }

            // update progress bar
            let progress = Math.round((i*100) / max);
            progressBar.attr("value", progress);
            progressBarProgress.text(`${progress}`);

        }, 0);
    }




    function splitSubstrings(str, length) {
        const words = str.split(' ');
        const chunks = [];

        for (let i = 0; i < words.length; i++) {
            const word = words[i];

            if (chunks.length === 0 || chunks[chunks.length - 1].length + word.length + 1 > length) {
                chunks.push(word);
            } else {
                chunks[chunks.length - 1] += ' ' + word;
            }
        }
        return chunks;
    }

    async function getTokens(text) {
        return await tokenizer(text)["input_ids"]["data"];
    }

    var editor = CodeMirror.fromTextArea(document.getElementById('input-text'), {
        lineNumbers: true,
        mode: 'text/plain',
        matchBrackets: true,
        lineWrapping: true,
    });


    function downloadPage() {
        var url = window.location.href;
        var a = document.createElement('a');
        a.download = 'download.html';
        a.href = url;
        a.click();
    }


    let nextButton = document.getElementById("next");
    let prevButton = document.getElementById("prev");

    function activateScrollButtons() {
        // Enable the next and prev buttons
        if (nextButton) {
            nextButton.removeAttribute("disabled");
        }

        if (prevButton) {
            prevButton.removeAttribute("disabled");
        }
    }

    function deactivateScrollButtons() {
        // Disable the next and prev buttons
        if (nextButton) {
            nextButton.setAttribute("disabled", "");
        }

        if (prevButton) {
            prevButton.setAttribute("disabled", "");
        }
    }



    let embedder;
    let tokenizer;
    async function main() {
        embedder = await pipeline("embeddings", 'Xenova/all-MiniLM-L6-v2'); // crops to 512 tokens
        // tokenizer = await AutoTokenizer.from_pretrained("Xenova/all-MiniLM-L6-v2");
        activateSubmitButton();
    }
    main();


    function nextMarker() {
        if (selectedIndex === -1) {
            highlightSelected(0);
        } else {
            highlightSelected((selectedIndex + 1) % markers.length);
            editor.scrollIntoView(markers[selectedIndex].find());
        }
    }

    function prevMarker() {
        if (selectedIndex === -1) {
            highlightSelected(0);
        } else {
            highlightSelected((selectedIndex - 1 + markers.length) % markers.length);
            editor.scrollIntoView(markers[selectedIndex].find());
        }
    }

    $('#next').click(function(event){
        event.preventDefault();
        nextMarker();
    });

    $('#prev').click(function(event){
        event.preventDefault();
        prevMarker();
    });


    function finishCallback() {
        ("Finished");
        submitButton.textContent = "Submit";
        isProcessing = false;

        activateScrollButtons();
    }

</script>

</body>
</html>
